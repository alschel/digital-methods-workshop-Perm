<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Perm Buildings Age Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.css' rel='stylesheet' />
    <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
    <style>
    body {
        margin: 0;
        padding: 0;
    }
    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }
    .map-overlay {
        position: absolute;
        width: 180px;
        top: 0;
        left: 10px;
        padding: 10px;
        margin-left: 5px;
        margin-top: 2px;
        margin-bottom: 2px;
        margin-right: 5px;
        z-index: 1;
    }
    </style>
  </head>
  <body>
    <div id='map'></div>
    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWxzY2hlbCIsImEiOiI0MGQxMGFmY2ViZTBhMjk5NDA1YTg2NzIxZjQyZWE2ZSJ9.LiQjz2oMBtEEPbhjGV-ogw';
    /*var bounds = [
        [-75.04728500751165, 39.68392799015035],
        [-72.91058699000139, 41.87764500765852]
    ];*/
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v9',
        center: [56.229398, 58.010374],
        zoom: 10,
        minZoom: 9,
        maxZoom: 18,
        pitch: 0,
        //maxBounds: bounds
    });

    map.on('load', function() {

      // If we just add the layer, it will cover all the labels.
      // To add layers below labels, first, let's create an arrow of label layers from the default style
      var layers = map.getStyle().layers;
      // Find the index of the first symbol layer in the map style
      var firstSymbolId;
      for (var i = 0; i < layers.length; i++) {
          if (layers[i].type === 'symbol') {
              firstSymbolId = layers[i].id;
              break;
          }
      };

      // Add layer with buildings
      map.addLayer({
        'id': 'buildings_age',
        'type': 'fill',
        'source': {
          'type': 'geojson',
          'data': 'data/perm_buildings_osm-year.geojson'
        },
        'layout': {},
        'paint': {
           'fill-color': {
             property: 'year',
             type: 'interval',
             stops: [
               [0, '#FDE725'],
               [1920, '#BCDF27'],
               [1930, '#7AD151'],
               [1940, '#43BF71'],
               [1950, '#22A884'],
               [1960, '#21908C'],
               [1970, '#2A788E'],
               [1980, '#35608D'],
               [1990, '#414487'],
               [2000, '#482576'],
               [2010, '#440154']
             ]
           },
           'fill-opacity': 0.8
         },
    // AddLayer method takes 2 arguments: the layer as an object, and a string
    // representing another layer's name. if the other layer
    // exists in the stylesheet already, the new layer will be positioned
    // right before that layer in the stack, making it possible to put
    // 'overlays' anywhere in the layer stack.
    // Insert the layer beneath the first symbol layer.
       }, firstSymbolId);
    });

    // Popups
    // Create a popup, but don't add it to the map yet.
    var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });

    // Add eventListener: 1st arg - type of eventListener, 2nd - layer id, 3d - function
    map.on('mouseenter', 'buildings_age', function(e) {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';

        // Create an array of all the features from the layer
        var features = map.queryRenderedFeatures(e.point, {
          layers: ['layer-name-here'] // replace this with the name of the layer
        });
        if (!features.length) {
          return;
        }
        // Select the first feature
        var feature = features[0];

        // Create coordinates and popup text
        var coordinates = feature.geometry.coordinates.slice();
        var description = '<h3>' + feature.properties.address + '</h3><p>' + feature.properties.year + '</p>';

        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        // Populate the popup and set its coordinates
        // based on the feature found.
        popup.setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
    });

    // Add eventListener: change cursor back and remove popup
    map.on('mouseleave', 'buildings_age', function() {
        map.getCanvas().style.cursor = '';
        popup.remove();
    });

    </script>
  </body>
</html>
